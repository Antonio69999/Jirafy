name: Deploy API to Runcloud

on:
  push:
    branches: [main]
    paths:
      - "api/**"

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy API to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/antoine/webapps/jirafy_api

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Moving to API directory ==="
            cd api

            echo "=== Installing Composer dependencies ==="
            composer install --optimize-autoloader --no-interaction --no-dev

            echo "=== Creating .env file ==="
            cat > .env << 'ENVEOF'
            APP_NAME=Jirafy
            APP_ENV=production
            APP_KEY=${{ secrets.APP_KEY }}
            APP_DEBUG=false
            APP_URL=https://jirafyapi.cda6.garage404.com

            APP_LOCALE=fr
            APP_FALLBACK_LOCALE=en
            APP_FAKER_LOCALE=en_US

            LOG_CHANNEL=stack
            LOG_STACK=single
            LOG_LEVEL=error

            DB_CONNECTION=pgsql
            DB_HOST=127.0.0.1
            DB_PORT=5433
            DB_DATABASE=jirafy
            DB_USERNAME=jirafy_user
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            SESSION_DRIVER=file
            SESSION_LIFETIME=120

            CACHE_STORE=file
            QUEUE_CONNECTION=sync

            JWT_SECRET=${{ secrets.JWT_SECRET }}

            CORS_ALLOWED_ORIGINS=https://jirafy.cda6.garage404.com
            ENVEOF

            echo "=== Setting permissions ==="
            chmod -R 775 storage bootstrap/cache
            chown -R antoine:antoine storage bootstrap/cache

            echo "=== Clearing caches ==="
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            echo "=== Testing database connection ==="
            php artisan db:show || echo "DB connection test skipped"

            echo "=== Running migrations ==="
            php artisan migrate --force

            echo "=== Caching for production ==="
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "âœ… API Deployment completed!"
