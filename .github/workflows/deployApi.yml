name: Deploy API with Database to Runcloud

on:
  push:
    branches: [main]
    paths: ["api/**", "docker-compose.yml", ".env.production"]

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy API to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/antoine/webapps/jirafy-api

            # Cloner ou mettre à jour le code
            if [ ! -d ".git" ]; then
              echo "=== First deployment ==="
              git clone https://github.com/Antonio69999/Jirafy.git .
            else
              echo "=== Updating code ==="
              git pull origin main
            fi

            # Copier le fichier d'environnement
            cp .env.production .env

            # Générer une clé APP_KEY si elle n'existe pas
            if ! grep -q "APP_KEY=base64:" .env; then
              echo "Generating APP_KEY..."
              docker-compose run --rm app php artisan key:generate --force
            fi

            # Arrêter les conteneurs existants
            docker-compose down

            # Construire et démarrer les services
            echo "=== Building and starting services ==="
            docker-compose up -d --build

            # Attendre que les services soient prêts
            echo "=== Waiting for services to be ready ==="
            sleep 30

            # Vérifier que tout fonctionne
            docker-compose ps

            echo "✅ API deployment with database completed!"
