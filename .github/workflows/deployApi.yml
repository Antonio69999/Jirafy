name: Deploy API with Database to Runcloud

on:
  push:
    branches: [main]
    paths:
      - "api/**"
      - "docker-compose.yml"

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy API to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/antoine/webapps/jirafy_api

            # Cloner ou mettre à jour le code
            if [ ! -d ".git" ]; then
              echo "=== First deployment ==="
              git clone https://github.com/Antonio69999/Jirafy.git .
            else
              echo "=== Updating code ==="
              git fetch origin main
              git reset --hard origin/main
            fi

            # Créer le fichier .env pour Docker Compose
            cat > .env << 'EOF'
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            APP_KEY=${{ secrets.APP_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EOF

            # Arrêter les conteneurs existants
            docker-compose down || true

            # Reconstruire l'API (pour prendre en compte le nouveau entrypoint.sh)
            docker-compose build --no-cache api

            # Démarrer les services
            docker-compose up -d

            # Attendre que tout soit prêt
            echo "=== Waiting for services ==="
            sleep 45

            # Vérifier le statut
            echo "=== Container status ==="
            docker-compose ps

            echo "=== API logs ==="
            docker-compose logs --tail=30 api

            echo "✅ Deployment completed!"
